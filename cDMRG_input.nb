(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     74247,       1913]
NotebookOptionsPosition[     73870,       1898]
NotebookOutlinePosition[     74263,       1914]
CellTagsIndexPosition[     74220,       1911]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{
  RowBox[{"(*", "Monomials", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"allmonomialsfixedorder", "[", 
      RowBox[{"n_", ",", "d_"}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"part", "=", 
         RowBox[{"IntegerPartitions", "[", 
          RowBox[{
           RowBox[{"d", "+", "n"}], ",", 
           RowBox[{"{", "n", "}"}]}], "]"}]}], "}"}], ",", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"Permutations", "/@", 
          RowBox[{"(", 
           RowBox[{"part", "-", "1"}], ")"}]}], ",", "1"}], "]"}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"allmonomials", "[", 
      RowBox[{"n_", ",", "dmax_"}], "]"}], ":=", 
     RowBox[{"Join", "@@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"allmonomialsfixedorder", "[", 
         RowBox[{"n", ",", "d"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"d", ",", "0", ",", "dmax"}], "}"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"monint", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"mon", ",", "_Real", ",", "1"}], "}"}], "}"}], ",", 
       RowBox[{"1.", "/", 
        RowBox[{"Times", "@@", 
         RowBox[{"Accumulate", "[", 
          RowBox[{"mon", "+", "1."}], "]"}]}]}], ",", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"fmonint", "[", "mon_", "]"}], ":=", 
     RowBox[{
      RowBox[{"fmonint", "[", "mon", "]"}], "=", 
      RowBox[{"monint", "[", "mon", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"makesym", "[", "lower_", "]"}], ":=", 
     RowBox[{"MapThread", "[", 
      RowBox[{"Join", ",", 
       RowBox[{"{", 
        RowBox[{"lower", ",", 
         RowBox[{"Rest", "/@", 
          RowBox[{"Flatten", "[", 
           RowBox[{"lower", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", "2", "}"}], ",", 
              RowBox[{"{", "1", "}"}]}], "}"}]}], "]"}]}]}], "}"}]}], "]"}]}],
     ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"symOuter", "[", 
      RowBox[{"f_", ",", "list_"}], "]"}], ":=", 
     RowBox[{"makesym", "@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"f", "[", 
         RowBox[{
          RowBox[{"list", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ",", 
          RowBox[{"list", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "list", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "i"}], "}"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Basis", " ", "construction"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"legendreKE", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"mon1", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"mon2", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"sum", "=", 
            RowBox[{"mon1", "+", "mon2"}]}], ",", 
           RowBox[{"prod", "=", 
            RowBox[{"mon1", "*", "mon2"}]}], ",", 
           RowBox[{"res", "=", "0."}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Do", "[", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"prod", "[", 
                RowBox[{"[", "i", "]"}], "]"}], "!=", "0"}], ",", 
              RowBox[{"res", "+=", 
               RowBox[{
                RowBox[{"prod", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], "*", 
                RowBox[{"monint", "@", 
                 RowBox[{"MapAt", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"#", "-", "1"}], "&"}], ",", "sum", ",", "i"}], 
                  "]"}]}]}]}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "[", "prod", "]"}]}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"res", "-", 
           RowBox[{
            RowBox[{"Total", "[", "prod", "]"}], "*", 
            RowBox[{"monint", "[", "sum", "]"}]}]}]}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"merge", "=", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"mon", ",", "_Integer", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "_Integer"}], "}"}]}], "}"}], ",", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"Take", "[", 
          RowBox[{"mon", ",", 
           RowBox[{"i", "-", "1"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"mon", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "+", 
           RowBox[{"mon", "[", 
            RowBox[{"[", 
             RowBox[{"i", "+", "1"}], "]"}], "]"}]}], "}"}], ",", 
         RowBox[{"Drop", "[", 
          RowBox[{"mon", ",", 
           RowBox[{"i", "+", "1"}]}], "]"}]}], "]"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"legendreIE", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"sum", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"merged", ",", 
           RowBox[{"res", "=", "0."}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"merged", "=", 
              RowBox[{"merge", "[", 
               RowBox[{"sum", ",", "i"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"res", "+=", 
              RowBox[{
               RowBox[{"monint", "@", 
                RowBox[{"MapAt", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"#", "+", "1"}], "&"}], ",", "merged", ",", "i"}], 
                 "]"}]}], "-", 
               RowBox[{"monint", "@", 
                RowBox[{"MapAt", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"#", "+", "2"}], "&"}], ",", "merged", ",", "i"}], 
                 "]"}]}]}]}], ";"}], ",", "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{
               RowBox[{"Length", "[", "sum", "]"}], "-", "1"}]}], "}"}]}], 
           "]"}], ";", "\[IndentingNewLine]", "res"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"flegendreIE", "[", "sum_", "]"}], ":=", 
     RowBox[{
      RowBox[{"flegendreIE", "[", "sum", "]"}], "=", 
      RowBox[{"legendreIE", "[", "sum", "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"legendrebasis", "[", 
      RowBox[{"n_", ",", "dmax_", ",", "c_", ",", "keep_"}], "]"}], ":=", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"n", "==", "0"}], ",", 
       RowBox[{"{", 
        RowBox[{"{", "1.", "}"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"monlist", "=", 
            RowBox[{"allmonomials", "[", 
             RowBox[{"n", ",", "dmax"}], "]"}]}], ",", "ov", ",", "kin", ",", 
           "int", ",", "akeep", ",", "eigenvecs", ",", 
           RowBox[{"scale", "=", 
            RowBox[{"n", "!"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ov", "=", 
           RowBox[{"symOuter", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"fmonint", "[", 
               RowBox[{"#1", "+", "#2"}], "]"}], "&"}], ",", "monlist"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"kin", "=", 
           RowBox[{"symOuter", "[", 
            RowBox[{"legendreKE", ",", "monlist"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"int", "=", 
           RowBox[{"symOuter", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"flegendreIE", "[", 
               RowBox[{"#1", "+", "#2"}], "]"}], "&"}], ",", "monlist"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"akeep", "=", 
           RowBox[{"Min", "[", 
            RowBox[{
             RowBox[{"Length", "[", "monlist", "]"}], ",", "keep"}], "]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"eigenvecs", "=", 
           RowBox[{"Reverse", "@", 
            RowBox[{"Eigenvectors", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"kin", "+", 
                 RowBox[{"c", "*", "int"}]}], " ", ",", "ov"}], "}"}], ",", 
              RowBox[{"-", "akeep"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "/", 
             RowBox[{"Sqrt", "[", 
              RowBox[{"scale", "*", 
               RowBox[{"(", 
                RowBox[{"#", ".", "ov", ".", "#"}], ")"}]}], "]"}]}], "&"}], "/@",
            "eigenvecs"}]}]}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Local", " ", "operators"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"KE", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"mon1", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"mon2", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"sum", "=", 
            RowBox[{"mon1", "+", "mon2"}]}], ",", 
           RowBox[{"prod", "=", 
            RowBox[{"mon1", "*", "mon2"}]}], ",", 
           RowBox[{"res", "=", "0."}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Do", "[", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"prod", "[", 
                RowBox[{"[", "i", "]"}], "]"}], "!=", "0"}], ",", 
              RowBox[{"res", "+=", 
               RowBox[{
                RowBox[{"prod", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], "*", 
                RowBox[{"monint", "@", 
                 RowBox[{"MapAt", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"#", "-", "2"}], "&"}], ",", "sum", ",", "i"}], 
                  "]"}]}]}]}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{"Length", "[", "prod", "]"}]}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "res"}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"kinoverlaps", "[", 
      RowBox[{"n_", ",", "dmax_"}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"monlist", "=", 
         RowBox[{"allmonomials", "[", 
          RowBox[{"n", ",", "dmax"}], "]"}]}], "}"}], ",", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"n", "!"}], "/", "2"}], ")"}], "*", 
        RowBox[{"symOuter", "[", 
         RowBox[{"KE", ",", "monlist"}], "]"}]}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"IE", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"sum", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"merged", ",", 
           RowBox[{"res", "=", "0."}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"merged", "=", 
              RowBox[{"merge", "[", 
               RowBox[{"sum", ",", "i"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"res", "+=", 
              RowBox[{"monint", "@", "merged"}]}], ";"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"i", ",", 
              RowBox[{
               RowBox[{"Length", "[", "sum", "]"}], "-", "1"}]}], "}"}]}], 
           "]"}], ";", "\[IndentingNewLine]", "res"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"fIE", "[", "sum_", "]"}], ":=", 
     RowBox[{
      RowBox[{"fIE", "[", "sum", "]"}], "=", 
      RowBox[{"IE", "[", "sum", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"intoverlaps", "[", 
      RowBox[{"n_", ",", "dmax_"}], "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"monlist", "=", 
         RowBox[{"allmonomials", "[", 
          RowBox[{"n", ",", "dmax"}], "]"}]}], "}"}], ",", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"n", "!"}], "/", "2"}], ")"}], "*", 
        RowBox[{"symOuter", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"fIE", "[", 
            RowBox[{"#1", "+", "#2"}], "]"}], "&"}], ",", "monlist"}], 
         "]"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"denscoefs", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"sum", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"n", "=", 
            RowBox[{"Length", "[", "sum", "]"}]}], ",", "powers", ",", 
           "coefs", ",", "phases", ",", "leftint", ",", "rightint", ",", 
           "middleint", ",", 
           RowBox[{"partialsums", "=", 
            RowBox[{"{", 
             RowBox[{"-", "1."}], "}"}]}], ",", "result", ",", "scale"}], 
          "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"powers", "=", 
           RowBox[{"Accumulate", "[", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"sum", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "}"}], ",", 
              RowBox[{
               RowBox[{"Rest", "[", "sum", "]"}], "+", "1"}]}], "]"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"result", "=", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0.", ",", 
             RowBox[{"1", "+", 
              RowBox[{"powers", "[", 
               RowBox[{"[", 
                RowBox[{"-", "1"}], "]"}], "]"}]}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"phases", "=", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"-", "1."}], ")"}], "^", 
            RowBox[{"Range", "[", "n", "]"}]}]}], ";", "\[IndentingNewLine]", 
          
          RowBox[{"leftint", "=", 
           RowBox[{"phases", "*", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"{", "1.", "}"}], ",", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"monint", "@", 
                 RowBox[{"Take", "[", 
                  RowBox[{"sum", ",", "i"}], "]"}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", 
                  RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"rightint", "=", 
           RowBox[{"phases", "*", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"monint", "@", 
                 RowBox[{"Drop", "[", 
                  RowBox[{"sum", ",", "j"}], "]"}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", 
                  RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}], ",", 
              RowBox[{"{", "1.", "}"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"AppendTo", "[", 
              RowBox[{"partialsums", ",", 
               RowBox[{
                RowBox[{"Sum", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"leftint", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "*", 
                   RowBox[{"monint", "[", 
                    RowBox[{"Take", "[", 
                    RowBox[{"sum", ",", 
                    RowBox[{"{", 
                    RowBox[{"j", ",", 
                    RowBox[{"i", "+", "1"}], ",", 
                    RowBox[{"-", "1"}]}], "}"}]}], "]"}], "]"}]}], ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", 
                    RowBox[{"j", "-", "1"}]}], "}"}]}], "]"}], "+", 
                RowBox[{"leftint", "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}]}], "]"}], ";"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"j", ",", "2", ",", "n"}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"coefs", "=", 
           RowBox[{"partialsums", "*", "rightint"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"scale", "=", 
           RowBox[{
            RowBox[{"N", "@", "n"}], "!"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Do", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"result", "[", 
              RowBox[{"[", 
               RowBox[{"1", "+", 
                RowBox[{"powers", "[", 
                 RowBox[{"[", "i", "]"}], "]"}]}], "]"}], "]"}], "=", 
             RowBox[{"scale", "*", 
              RowBox[{"coefs", "[", 
               RowBox[{"[", "i", "]"}], "]"}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "n"}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "result"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"fdenscoefs", "[", "sum_", "]"}], ":=", 
     RowBox[{
      RowBox[{"fdenscoefs", "[", "sum", "]"}], "=", 
      RowBox[{"denscoefs", "[", "sum", "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"densoverlaps", "[", 
      RowBox[{"n_", ",", "dmax_"}], "]"}], ":=", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"n", "==", "0"}], ",", 
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{"{", "}"}], "}"}], "}"}], ",", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"monlist", "=", 
           RowBox[{"allmonomials", "[", 
            RowBox[{"n", ",", "dmax"}], "]"}]}], "}"}], ",", 
         RowBox[{"symOuter", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"fdenscoefs", "[", 
             RowBox[{"#1", "+", "#2"}], "]"}], "&"}], ",", "monlist"}], 
          "]"}]}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"poly", "[", 
      RowBox[{
       RowBox[{"coefs_", "?", "VectorQ"}], ",", "x_"}], "]"}], ":=", 
     RowBox[{"coefs", ".", 
      RowBox[{"x", "^", 
       RowBox[{"Range", "[", 
        RowBox[{"0", ",", 
         RowBox[{
          RowBox[{"Length", "@", "coefs"}], "-", "1"}]}], "]"}]}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"poly", "[", 
      RowBox[{
       RowBox[{"coefs_", "?", "VectorQ"}], ",", "0"}], "]"}], ":=", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"coefs", "!=", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"coefs", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ",", "0"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"poly", "[", 
      RowBox[{
       RowBox[{"table_", "/;", 
        RowBox[{"MatrixQ", "[", 
         RowBox[{"table", ",", "VectorQ"}], "]"}]}], ",", "x_"}], "]"}], ":=", 
     RowBox[{"Map", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"poly", "[", 
         RowBox[{"#", ",", "x"}], "]"}], "&"}], ",", "table", ",", 
       RowBox[{"{", "2", "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"psicoefs", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"smallmon", ",", "_Integer", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"bigmon", ",", "_Integer", ",", "1"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"suml", "=", 
            RowBox[{"smallmon", "+", 
             RowBox[{"Most", "[", "bigmon", "]"}]}]}], ",", 
           RowBox[{"sumr", "=", 
            RowBox[{"smallmon", "+", 
             RowBox[{"Rest", "[", "bigmon", "]"}]}]}], ",", 
           RowBox[{"n", "=", 
            RowBox[{"Length", "[", "bigmon", "]"}]}], ",", "powers", ",", 
           "coefs", ",", "phases", ",", "leftint", ",", "rightint", ",", 
           "middleint", ",", 
           RowBox[{"partialsums", "=", 
            RowBox[{"{", 
             RowBox[{"-", "1."}], "}"}]}], ",", "result", ",", "scale"}], 
          "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"powers", "=", 
           RowBox[{"Accumulate", "[", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"bigmon", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "}"}], ",", 
              RowBox[{"sumr", "+", "1"}]}], "]"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"result", "=", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0.", ",", 
             RowBox[{"1", "+", 
              RowBox[{"powers", "[", 
               RowBox[{"[", 
                RowBox[{"-", "1"}], "]"}], "]"}]}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"phases", "=", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"-", "1."}], ")"}], "^", 
            RowBox[{"Range", "[", "n", "]"}]}]}], ";", "\[IndentingNewLine]", 
          
          RowBox[{"leftint", "=", 
           RowBox[{"phases", "*", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"{", "1.", "}"}], ",", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"monint", "@", 
                 RowBox[{"Take", "[", 
                  RowBox[{"suml", ",", "i"}], "]"}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", 
                  RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}]}], "]"}]}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"rightint", "=", 
           RowBox[{"phases", "*", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"monint", "@", 
                 RowBox[{"Drop", "[", 
                  RowBox[{"sumr", ",", "j"}], "]"}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", "0", ",", 
                  RowBox[{"n", "-", "2"}]}], "}"}]}], "]"}], ",", 
              RowBox[{"{", "1.", "}"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"AppendTo", "[", 
              RowBox[{"partialsums", ",", 
               RowBox[{
                RowBox[{"Sum", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"leftint", "[", 
                    RowBox[{"[", "i", "]"}], "]"}], "*", 
                   RowBox[{"monint", "[", 
                    RowBox[{"Take", "[", 
                    RowBox[{"sumr", ",", 
                    RowBox[{"{", 
                    RowBox[{"j", ",", "i", ",", 
                    RowBox[{"-", "1"}]}], "}"}]}], "]"}], "]"}]}], ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "j"}], "}"}]}], "]"}], "+", 
                RowBox[{"leftint", "[", 
                 RowBox[{"[", 
                  RowBox[{"j", "+", "1"}], "]"}], "]"}]}]}], "]"}], ";"}], 
            ",", "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"j", ",", 
              RowBox[{"n", "-", "1"}]}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"coefs", "=", 
           RowBox[{"partialsums", "*", "rightint"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"scale", "=", 
           RowBox[{
            RowBox[{"Sqrt", "[", 
             RowBox[{"N", "@", "n"}], "]"}], "*", 
            RowBox[{"Gamma", "[", 
             RowBox[{"N", "@", "n"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Do", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"result", "[", 
              RowBox[{"[", 
               RowBox[{"1", "+", 
                RowBox[{"powers", "[", 
                 RowBox[{"[", "i", "]"}], "]"}]}], "]"}], "]"}], "=", 
             RowBox[{"scale", "*", 
              RowBox[{"coefs", "[", 
               RowBox[{"[", "i", "]"}], "]"}]}]}], ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "n"}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "result"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"psioverlaps", "[", 
      RowBox[{"n_", ",", "dmaxSmall_", ",", "dmaxBig_"}], "]"}], ":=", 
     "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"smallmons", "=", 
          RowBox[{"allmonomials", "[", 
           RowBox[{
            RowBox[{"n", "-", "1"}], ",", "dmaxSmall"}], "]"}]}], ",", 
         RowBox[{"bigmons", "=", 
          RowBox[{"allmonomials", "[", 
           RowBox[{"n", ",", "dmaxBig"}], "]"}]}]}], "}"}], ",", 
       RowBox[{"Outer", "[", 
        RowBox[{"psicoefs", ",", "smallmons", ",", "bigmons", ",", "1"}], 
        "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"incgamma", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"p", ",", "_Integer"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"z", ",", "_Complex"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"sum", "=", 
            RowBox[{"1.", "+", 
             RowBox[{"0.", "*", "I"}]}]}], ",", "residue", ",", 
           RowBox[{"k", "=", "1."}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"residue", "=", "sum"}], ";", "\[IndentingNewLine]", 
          RowBox[{"While", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Abs", "[", 
              RowBox[{"residue", "/", "sum"}], "]"}], ">", 
             RowBox[{"10", "^", 
              RowBox[{"-", "15."}]}]}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"residue", "*=", 
              RowBox[{"z", "/", 
               RowBox[{"(", 
                RowBox[{"p", "+", "k"}], ")"}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"sum", "+=", "residue"}], ";", "\[IndentingNewLine]", 
             RowBox[{"k", "++"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Exp", "[", 
            RowBox[{"-", "z"}], "]"}], "*", 
           RowBox[{"z", "^", "p"}], "*", 
           RowBox[{"sum", "/", "p"}]}]}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PE", "=", "\[IndentingNewLine]", 
     RowBox[{"Compile", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ncoefs", ",", "_Real", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"a", ",", "_Real"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"b", ",", "_Real"}], "}"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"len", "=", 
            RowBox[{"Length", "[", "ncoefs", "]"}]}], ",", 
           RowBox[{"res", "=", "0."}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"ncoefs", "[", 
                RowBox[{"[", "p", "]"}], "]"}], "!=", "0"}], ",", 
              RowBox[{"res", "+=", 
               RowBox[{
                RowBox[{"ncoefs", "[", 
                 RowBox[{"[", "p", "]"}], "]"}], "*", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"1.", "/", "p"}], "+", 
                  RowBox[{
                   RowBox[{"Re", "[", 
                    RowBox[{
                    RowBox[{"I", "^", "p"}], "*", 
                    RowBox[{"Exp", "[", 
                    RowBox[{"I", "*", "b"}], "]"}], "*", 
                    RowBox[{"incgamma", "[", 
                    RowBox[{"p", ",", 
                    RowBox[{
                    RowBox[{"-", "I"}], "*", "a"}]}], "]"}]}], "]"}], "/", 
                   RowBox[{"a", "^", "p"}]}]}], ")"}]}]}]}], "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"p", ",", "len"}], "}"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "res"}]}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
       RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}]}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"symPE", "[", 
      RowBox[{"matncoefs_", ",", 
       RowBox[{"{", 
        RowBox[{"a_", ",", "b_"}], "}"}]}], "]"}], ":=", 
     RowBox[{"makesym", "@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"PE", "[", 
         RowBox[{
          RowBox[{"matncoefs", "[", 
           RowBox[{"[", 
            RowBox[{"i", ",", "j"}], "]"}], "]"}], ",", "a", ",", "b"}], 
         "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", 
          RowBox[{"Length", "[", "matncoefs", "]"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "i"}], "}"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"blockmatrix", "[", "blocks_", "]"}], ":=", 
     RowBox[{"SparseArray", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Band", "[", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1"}], "}"}], "]"}], "\[Rule]", "blocks"}], "}"}],
       "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"sblockmatrix", "[", "blocks_", "]"}], ":=", 
     RowBox[{"SparseArray", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Band", "[", 
          RowBox[{"{", 
           RowBox[{"1", ",", "2"}], "}"}], "]"}], "\[Rule]", "blocks"}], 
        "}"}], ",", 
       RowBox[{"1", "+", 
        RowBox[{"Plus", "@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"Last", "[", 
             RowBox[{"Dimensions", "[", "#", "]"}], "]"}], "&"}], "/@", 
           "blocks"}], ")"}]}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"makebasis", "[", 
      RowBox[{
       RowBox[{"basisparams_", "?", "MatrixQ"}], ",", "numsegments_Integer", 
       ",", 
       RowBox[{"g_", "?", "NumericQ"}], ",", 
       RowBox[{"numwells_", "?", "NumericQ"}], ",", 
       RowBox[{"V0_", "?", "NumericQ"}], ",", 
       RowBox[{"maxpower_", ":", "Infinity"}]}], "]"}], ":=", 
     "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "dmaxlist", ",", "keeps", ",", "\[Delta]x", ",", "nmax", ",", "bases",
          ",", "txmat", ",", "kinblocks", ",", "kinmonomial", ",", "kin", ",",
          "intblocks", ",", "intmonomial", ",", "int", ",", "Hsitebox", ",", 
         "psiblocks", ",", "psimaxlen", ",", "psiblockspadded", ",", 
         "psicoefmonomial", ",", "densblocks", ",", "densmaxlen", ",", 
         "densblockspadded", ",", "denscoefmonomial", ",", "boundaries", ",", 
         "widths", ",", "arglist", ",", "pots"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"dmaxlist", ",", "keeps"}], "}"}], "=", 
         RowBox[{"Transpose", "@", 
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"{", 
              RowBox[{"0", ",", "1"}], "}"}], "}"}], ",", "basisparams"}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"\[Delta]x", "=", 
         RowBox[{"1.", "/", "numsegments"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"nmax", "=", 
         RowBox[{"Length", "[", "basisparams", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"bases", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"legendrebasis", "[", 
            RowBox[{
             RowBox[{"#", "-", "1"}], ",", 
             RowBox[{"dmaxlist", "[", 
              RowBox[{"[", "#", "]"}], "]"}], ",", 
             RowBox[{"g", "*", "\[Delta]x"}], ",", 
             RowBox[{"keeps", "[", 
              RowBox[{"[", "#", "]"}], "]"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Range", "[", 
           RowBox[{"nmax", "+", "1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"txmat", "=", 
         RowBox[{"blockmatrix", "[", "bases", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"basisdims", "=", 
         RowBox[{"Length", "/@", "bases"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"localqn", "=", 
         RowBox[{"Flatten", "@", 
          RowBox[{"MapIndexed", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"ConstantArray", "[", 
              RowBox[{
               RowBox[{"#2", "-", "1"}], ",", "#1"}], "]"}], "&"}], ",", 
            "basisdims"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"kinblocks", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"kinoverlaps", "[", 
            RowBox[{
             RowBox[{"#", "-", "1"}], ",", 
             RowBox[{"dmaxlist", "[", 
              RowBox[{"[", "#", "]"}], "]"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Range", "[", 
           RowBox[{"nmax", "+", "1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"kinmonomial", "=", 
         RowBox[{"blockmatrix", "[", "kinblocks", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"kin", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"txmat", "/", 
            RowBox[{"\[Delta]x", "^", "2"}]}], ")"}], ".", "kinmonomial", ".", 
          RowBox[{"Transpose", "[", "txmat", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"intblocks", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"intoverlaps", "[", 
            RowBox[{
             RowBox[{"#", "-", "1"}], ",", 
             RowBox[{"dmaxlist", "[", 
              RowBox[{"[", "#", "]"}], "]"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Range", "[", 
           RowBox[{"nmax", "+", "1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"intmonomial", "=", 
         RowBox[{"blockmatrix", "[", "intblocks", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"int", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"g", "/", "\[Delta]x"}], ")"}], "*", "txmat"}], ")"}], 
          ".", "intmonomial", ".", 
          RowBox[{"Transpose", "[", "txmat", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Hsitebox", "=", 
         RowBox[{"kin", "+", "int"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"psiblocks", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"psioverlaps", "[", 
            RowBox[{"#", ",", 
             RowBox[{"dmaxlist", "[", 
              RowBox[{"[", "#", "]"}], "]"}], ",", 
             RowBox[{"dmaxlist", "[", 
              RowBox[{"[", 
               RowBox[{"#", "+", "1"}], "]"}], "]"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Range", "[", "nmax", "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"psimaxlen", "=", 
         RowBox[{"Max", "@", 
          RowBox[{"Map", "[", 
           RowBox[{"Length", ",", "psiblocks", ",", 
            RowBox[{"{", "3", "}"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"apsimaxlen", "=", 
         RowBox[{"Min", "[", 
          RowBox[{"psimaxlen", ",", 
           RowBox[{"maxpower", "+", "1"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"psiblockspadded", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"PadRight", "[", 
             RowBox[{"#", ",", "apsimaxlen"}], "]"}], "&"}], ",", "psiblocks",
            ",", 
           RowBox[{"{", "3", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"psicoefmonomial", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"sblockmatrix", "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"TensorTranspose", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"2", ",", "3", ",", "1"}], "}"}]}], "]"}], "&"}], "/@",
              "psiblockspadded"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"psicoef", "=", 
         RowBox[{"TensorTranspose", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"txmat", "/", 
              RowBox[{"Sqrt", "[", "\[Delta]x", "]"}]}], ")"}], ".", 
            RowBox[{"Transpose", "[", "psicoefmonomial", "]"}], ".", 
            RowBox[{"Transpose", "[", "txmat", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"psiL", "=", 
         RowBox[{"SparseArray", "@", 
          RowBox[{"poly", "[", 
           RowBox[{"psicoef", ",", "0"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"psiR", "=", 
         RowBox[{"SparseArray", "@", 
          RowBox[{"poly", "[", 
           RowBox[{"psicoef", ",", "1"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"densblocks", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"densoverlaps", "[", 
            RowBox[{
             RowBox[{"#", "-", "1"}], ",", 
             RowBox[{"dmaxlist", "[", 
              RowBox[{"[", "#", "]"}], "]"}]}], "]"}], "&"}], "/@", 
          RowBox[{"Range", "[", 
           RowBox[{"nmax", "+", "1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"densmaxlen", "=", 
         RowBox[{"Max", "@", 
          RowBox[{"Map", "[", 
           RowBox[{"Length", ",", "densblocks", ",", 
            RowBox[{"{", "3", "}"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"adensmaxlen", "=", 
         RowBox[{"Min", "[", 
          RowBox[{"densmaxlen", ",", 
           RowBox[{"maxpower", "+", "1"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"densblockspadded", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"PadRight", "[", 
             RowBox[{"#", ",", "adensmaxlen"}], "]"}], "&"}], ",", 
           "densblocks", ",", 
           RowBox[{"{", "3", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"denscoefmonomial", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"blockmatrix", "/@", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"TensorTranspose", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"2", ",", "3", ",", "1"}], "}"}]}], "]"}], "&"}], "/@",
              "densblockspadded"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"denscoef", "=", 
         RowBox[{"TensorTranspose", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"txmat", "/", "\[Delta]x"}], ")"}], ".", 
            RowBox[{"Transpose", "[", "denscoefmonomial", "]"}], ".", 
            RowBox[{"Transpose", "[", "txmat", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"boundaries", "=", 
         RowBox[{"N", "@", 
          RowBox[{"Subdivide", "[", "numsegments", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"widths", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"\[Delta]x", ",", "numsegments"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"arglist", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"2", "*", "numwells", "*", "\[Pi]"}], ")"}], "*", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{"widths", ",", 
             RowBox[{"Most", "[", "boundaries", "]"}]}], "}"}], "]"}]}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"pots", "=", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"V0", "*", 
              RowBox[{"\[Delta]x", "/", "2"}]}], ")"}], "*", 
            RowBox[{"SparseArray", "@", 
             RowBox[{"symPE", "[", 
              RowBox[{
               RowBox[{"Normal", "@", "denscoef"}], ",", "#"}], "]"}]}]}], 
           "&"}], "/@", "arglist"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Hsite", "[", "j", "]"}], "=", 
           RowBox[{"Hsitebox", "+", 
            RowBox[{"pots", "[", 
             RowBox[{"[", "j", "]"}], "]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "numsegments"}], "}"}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Initial", " ", "state"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"equispacedpos", "[", "particles_", "]"}], ":=", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"particles", "\[Equal]", "0"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"Ceiling", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Range", "@", "particles"}], "-", 
           RowBox[{"1", "/", "2"}]}], ")"}], "*", 
         RowBox[{"numsegments", "/", "particles"}]}], "]"}]}], "]"}]}], ";"}],
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"equispacedvec", ":=", "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "filling", ",", "remainder", ",", "occupations", ",", "posrules"}], 
        "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"filling", ",", "remainder"}], "}"}], "=", 
         RowBox[{"QuotientRemainder", "[", 
          RowBox[{"particles", ",", "numsegments"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"occupations", "=", 
         RowBox[{"MapAt", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "+", "1"}], "&"}], ",", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"filling", ",", "numsegments"}], "]"}], ",", 
           RowBox[{"Transpose", "[", 
            RowBox[{"{", 
             RowBox[{"equispacedpos", "[", "remainder", "]"}], "}"}], "]"}]}],
           "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"posrules", "=", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"0", "->", "1"}], "}"}], ",", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"#2", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "->", "#1"}], "&"}], ",", 
             RowBox[{"Most", "[", 
              RowBox[{
               RowBox[{"Accumulate", "[", "basisdims", "]"}], "+", "1"}], 
              "]"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"occupations", "/.", "posrules"}]}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Creating", " ", "input", " ", "file", " ", "for", " ", "DMRG"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"cfloat", "[", 
      RowBox[{"q_", "?", "NumericQ"}], "]"}], ":=", 
     RowBox[{"ToString", "[", 
      RowBox[{"CForm", "[", 
       RowBox[{"N", "@", "q"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{
     RowBox[{"cformat", "[", "val_", "]"}], ":=", "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Head", "[", 
             RowBox[{"N", "@", "val"}], "]"}], "\[Equal]", "Real"}], " ", "&&",
            " ", 
           RowBox[{"Not", "[", 
            RowBox[{
             RowBox[{"Head", "[", "val", "]"}], "===", "Integer"}], "]"}]}], 
          ",", 
          RowBox[{"Return", "@", 
           RowBox[{"cfloat", "[", 
            RowBox[{"N", "@", "val"}], "]"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"val", "\[Equal]", "True"}], ",", 
          RowBox[{"Return", "[", "\"\<true\>\"", "]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"val", "\[Equal]", "False"}], ",", 
          RowBox[{"Return", "[", "\"\<false\>\"", "]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ToString", "[", "val", "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"outputParams", "[", 
      RowBox[{
      "file_OutputStream", ",", "name_String", ",", "parameters_List"}], 
      "]"}], ":=", "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "name"}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<{\>\""}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"writeParam", "[", 
           RowBox[{"file", ",", "#"}], "]"}], "&"}], "/@", "parameters"}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<}\>\""}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<\>\""}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"writeParam", "[", 
      RowBox[{"file_OutputStream", ",", "prule_Rule"}], "]"}], ":=", 
     "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"param", "=", 
          RowBox[{"prule", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"val", "=", 
          RowBox[{"prule", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"WriteString", "[", 
         RowBox[{"file", ",", 
          RowBox[{"param", "<>", "\"\<=\>\""}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", 
          RowBox[{"cformat", "[", "val", "]"}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"outputVec", "[", 
      RowBox[{"file_OutputStream", ",", "name_String", ",", "vec_List"}], 
      "]"}], ":=", "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "name"}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<{\>\""}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"WriteString", "[", 
           RowBox[{"file", ",", 
            RowBox[{"cformat", "[", "#", "]"}], ",", "\"\< \>\""}], "]"}], 
          "&"}], "/@", "vec"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<}\>\""}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<\>\""}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"outputMat", "[", 
      RowBox[{"file_OutputStream", ",", "name_String", ",", "rules_List"}], 
      "]"}], ":=", "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"numrules", "=", 
         RowBox[{"Length", "[", "rules", "]"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "name"}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<{\>\""}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", 
          RowBox[{"ToString", "[", "numrules", "]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"writeRule", "[", 
           RowBox[{"file", ",", "#"}], "]"}], "&"}], "/@", "rules"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<}\>\""}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<\>\""}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"writeRule", "[", 
      RowBox[{"file_OutputStream", ",", "line_Rule"}], "]"}], ":=", 
     "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"dat", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{"List", "@@", "line"}], "]"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"WriteString", "[", 
           RowBox[{"file", ",", 
            RowBox[{"cformat", "[", "#", "]"}], ",", "\"\< \>\""}], "]"}], 
          "&"}], "/@", "dat"}], ";", "\[IndentingNewLine]", 
        RowBox[{"WriteLine", "[", 
         RowBox[{"file", ",", "\"\<\>\""}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"createInputFile", "[", 
      RowBox[{"filename_String", ",", "paramset_List"}], "]"}], ":=", 
     "\[IndentingNewLine]", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"file", ",", 
         RowBox[{"parameters", "=", 
          RowBox[{"\"\<parameters\>\"", "/.", "paramset"}]}], ",", 
         RowBox[{"vecparams", "=", 
          RowBox[{"\"\<vecparams\>\"", "/.", "paramset"}]}], ",", 
         RowBox[{"localmats", "=", 
          RowBox[{"\"\<localmats\>\"", "/.", "paramset"}]}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"file", "=", 
         RowBox[{"OpenWrite", "[", "filename", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"outputParams", "[", 
         RowBox[{"file", ",", "\"\<parameters\>\"", ",", "parameters"}], 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"outputVec", "[", 
           RowBox[{"file", ",", "#1", ",", "#2"}], "]"}], "&"}], "@@@", 
         "vecparams"}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"outputMat", "[", 
           RowBox[{"file", ",", "#1", ",", 
            RowBox[{"Most", "@", 
             RowBox[{"ArrayRules", "@", 
              RowBox[{"Transpose", "[", "#2", "]"}]}]}]}], "]"}], "&"}], "@@@",
          "localmats"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Close", "[", "file", "]"}], ";"}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Command", "-", 
     RowBox[{"line", " ", "inputs"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"particles", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "5", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"gamma", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "6", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"numwells", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "7", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"V0byEr", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "8", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"numsegments", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "9", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"basisid", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "10", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"epsid", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "11", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"saveid", "=", 
     RowBox[{"ToExpression", "[", 
      RowBox[{"$CommandLine", "[", 
       RowBox[{"[", "12", "]"}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Basis", ",", " ", "DMRG", ",", " ", 
     RowBox[{"and", " ", "save", " ", "parameters"}]}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"basistable", "=", 
     RowBox[{"Import", "[", "\"\<Parameters/basistable.m\>\"", "]"}]}], ";"}],
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"MemberQ", "[", 
       RowBox[{
        RowBox[{"Range", "@", 
         RowBox[{"Length", "[", "basistable", "]"}]}], ",", "basisid"}], 
       "]"}], ",", 
      RowBox[{"basisparams", "=", 
       RowBox[{"basistable", "[", 
        RowBox[{"[", 
         RowBox[{"basisid", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{
       RowBox[{"Print", "[", "\"\<Basis ID not found\>\"", "]"}], ";", 
       RowBox[{"Exit", "[", "]"}]}]}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Clear", "[", "basistable", "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"epstable", "=", 
     RowBox[{"Import", "[", "\"\<Parameters/epstable.m\>\"", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"MemberQ", "[", 
       RowBox[{
        RowBox[{"Range", "@", 
         RowBox[{"Length", "[", "epstable", "]"}]}], ",", "epsid"}], "]"}], 
      ",", 
      RowBox[{"sweepparams", "=", 
       RowBox[{"epstable", "[", 
        RowBox[{"[", 
         RowBox[{"epsid", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{
       RowBox[{"Print", "[", "\"\<Eps ID not found\>\"", "]"}], ";", 
       RowBox[{"Exit", "[", "]"}]}]}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"targetdiscontinuity", "=", 
     RowBox[{"\"\<targetdisc\>\"", "/.", "sweepparams"}]}], ";", 
    RowBox[{"epsparams", "=", 
     RowBox[{"Rest", "[", "sweepparams", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Clear", "[", 
     RowBox[{"epstable", ",", "sweepparams"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"savetable", "=", 
     RowBox[{"Import", "[", "\"\<Parameters/savetable.m\>\"", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"MemberQ", "[", 
       RowBox[{
        RowBox[{"Range", "@", 
         RowBox[{"Length", "[", "savetable", "]"}]}], ",", "saveid"}], "]"}], 
      ",", 
      RowBox[{"fullsaveparams", "=", 
       RowBox[{"savetable", "[", 
        RowBox[{"[", 
         RowBox[{"saveid", ",", "2"}], "]"}], "]"}]}], ",", 
      RowBox[{
       RowBox[{"Print", "[", "\"\<Save ID not found\>\"", "]"}], ";", 
       RowBox[{"Exit", "[", "]"}]}]}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"maxpower", "=", 
     RowBox[{"\"\<maxpower\>\"", "/.", "fullsaveparams"}]}], ";", 
    RowBox[{"saveparams", "=", 
     RowBox[{"Rest", "[", "fullsaveparams", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Clear", "[", 
     RowBox[{"savetable", ",", "fullsaveparams"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "Calculate", " ", "basis", " ", "and", " ", "local", " ", "operators"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"g", "=", 
     RowBox[{"gamma", "*", "particles"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Er", "=", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"numwells", "*", "\[Pi]"}], ")"}], "^", "2."}], "/", "2"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"V0", "=", 
     RowBox[{"V0byEr", "*", "Er"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"makebasis", "[", 
     RowBox[{
     "basisparams", ",", "numsegments", ",", "g", ",", "numwells", ",", "V0", 
      ",", "maxpower"}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Clear", "[", 
     RowBox[{"fmonint", ",", "flegendreIE", ",", "fIE", ",", "fdenscoefs"}], 
     "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Set", " ", "initial", " ", "state"}], "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"initialvec", "=", "equispacedvec"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"loadfromfile", "=", "False"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Set", " ", "file", " ", "name"}], "*)"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{
     RowBox[{"namestr", "[", 
      RowBox[{
       RowBox[{"x_", "?", "StringQ"}], ",", 
       RowBox[{"y_", "?", "NumericQ"}]}], "]"}], ":=", 
     RowBox[{"\"\<_\>\"", "<>", "x", "<>", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"0", "<", "y", "<", "0.001"}], "||", 
         RowBox[{"y", "\[GreaterEqual]", 
          RowBox[{"10", "^", "4"}]}]}], ",", 
        RowBox[{"\"\<_1E\>\"", "<>", 
         RowBox[{"ToString", "@", 
          RowBox[{"Rationalize", "[", 
           RowBox[{
            RowBox[{"Log", "[", 
             RowBox[{"10", ",", "y"}], "]"}], ",", "0"}], "]"}]}]}], ",", 
        RowBox[{"\"\<_\>\"", "<>", 
         RowBox[{"ToString", "[", "y", "]"}]}]}], "]"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"namestr", "[", 
      RowBox[{
       RowBox[{"x_", "?", "StringQ"}], ",", 
       RowBox[{"y_", "?", "StringQ"}]}], "]"}], ":=", 
     RowBox[{"\"\<_\>\"", "<>", "x", "<>", "\"\<_\>\"", "<>", "y"}]}], ";"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"namestr", "[", 
      RowBox[{"list_", "?", "MatrixQ"}], "]"}], ":=", 
     RowBox[{"StringDrop", "[", 
      RowBox[{
       RowBox[{"StringJoin", "[", 
        RowBox[{"namestr", "@@@", "list"}], "]"}], ",", "1"}], "]"}]}], ";"}],
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"id", "=", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"\"\<N\>\"", ",", "particles"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<gamma\>\"", ",", "gamma"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<Nwells\>\"", ",", "numwells"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<V0\>\"", ",", "V0byEr"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<M\>\"", ",", "numsegments"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<basisparams\>\"", ",", "basisid"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"\"\<sweepparams\>\"", ",", "epsid"}], "}"}]}], "}"}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"name", "=", 
     RowBox[{"\"\<Runs/\>\"", "<>", 
      RowBox[{"namestr", "[", "id", "]"}], "<>", "\"\<_ITensor\>\""}]}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
    "Write", " ", "parameters", " ", "to", " ", "input", " ", "file"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"paramlist", "=", "\[IndentingNewLine]", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\"\<numsites\>\"", "\[Rule]", "numsegments"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
       "\"\<targetdiscontinuity\>\"", "\[Rule]", "targetdiscontinuity"}], ",",
        "\[IndentingNewLine]", 
       RowBox[{"\"\<numeps\>\"", "\[Rule]", 
        RowBox[{"Length", "[", 
         RowBox[{"\"\<eps\>\"", "/.", "epsparams"}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<numstates\>\"", "\[Rule]", 
        RowBox[{"Total", "[", "basisdims", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<maxorder\>\"", "\[Rule]", 
        RowBox[{"Max", "[", 
         RowBox[{"apsimaxlen", ",", "adensmaxlen"}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<loadfromfile\>\"", "\[Rule]", "loadfromfile"}]}], 
      "\[IndentingNewLine]", "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"paramset", "=", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\"\<parameters\>\"", "\[Rule]", 
        RowBox[{"Join", "[", 
         RowBox[{"paramlist", ",", "saveparams", ",", 
          RowBox[{"If", "[", 
           RowBox[{"loadfromfile", ",", 
            RowBox[{"{", 
             RowBox[{
             "\"\<loadfromfilename\>\"", "\[Rule]", "loadfromfilename"}], 
             "}"}], ",", 
            RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<vecparams\>\"", "\[Rule]", 
        RowBox[{"Join", "[", 
         RowBox[{"epsparams", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<qns\>\"", "\[Rule]", "localqn"}], ",", 
            RowBox[{"\"\<initialvec\>\"", "\[Rule]", "initialvec"}]}], 
           "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"\"\<localmats\>\"", "\[Rule]", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<psiL\>\"", "\[Rule]", "psiL"}], ",", 
            RowBox[{"\"\<psiR\>\"", "\[Rule]", "psiR"}], ",", 
            RowBox[{"\"\<psi\>\"", "\[Rule]", "psicoef"}], ",", 
            RowBox[{"\"\<n\>\"", "\[Rule]", "denscoef"}]}], "}"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"\"\<H\>\"", "<>", 
              RowBox[{"ToString", "[", "#", "]"}]}], "\[Rule]", 
             RowBox[{"Hsite", "[", "#", "]"}]}], "&"}], "/@", 
           RowBox[{"Range", "[", "numsegments", "]"}]}]}], "]"}]}]}], "}"}]}],
     ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"createInputFile", "[", 
     RowBox[{
      RowBox[{"name", "<>", "\"\<.txt\>\""}], ",", "paramset"}], "]"}], ";"}],
    "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Run", " ", "DMRG"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Run", "[", 
     RowBox[{
     "\"\<./cDMRG \>\"", "<>", "name", "<>", "\"\<.txt >\>\"", "<>", "name", 
      "<>", "\"\<.out 2>\>\"", "<>", "name", "<>", "\"\<.error\>\""}], "]"}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"Post", " ", "processing"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"\"\<savelocaldms\>\"", "/.", "saveparams"}], ")"}], "&&", 
       RowBox[{"(", 
        RowBox[{"\"\<savefinalmeas\>\"", "/.", "saveparams"}], ")"}]}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"localdms", "=", 
        RowBox[{"SparseArray", "@", 
         RowBox[{"Import", "[", 
          RowBox[{"name", "<>", "\"\<_localdms.m\>\""}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"varPartition", "[", 
         RowBox[{"l_", ",", "p_"}], "]"}], ":=", 
        RowBox[{"MapThread", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"l", "[", 
            RowBox[{"[", 
             RowBox[{"#", ";;", "#2"}], "]"}], "]"}], "&"}], ",", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"{", "0", "}"}], "~", "Join", "~", 
                RowBox[{"Most", "@", "#"}]}], "+", "1"}], ",", "#"}], "}"}], 
            "&"}], "@", 
           RowBox[{"Accumulate", "@", "p"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"avgoccs", "=", 
        RowBox[{"varPartition", "[", 
         RowBox[{
          RowBox[{"Normal", "@", 
           RowBox[{"Mean", "[", 
            RowBox[{"Diagonal", "/@", "localdms"}], "]"}]}], ",", 
          "basisdims"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"finalmeas", "=", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"Import", "[", 
           RowBox[{"name", "<>", "\"\<_finalmeas.m\>\""}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"\"\<avgoccupations\>\"", "\[Rule]", "avgoccs"}], "}"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Export", "[", 
        RowBox[{
         RowBox[{"name", "<>", "\"\<_finalmeas.m\>\""}], ",", "finalmeas"}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", 
        RowBox[{"localdms", ",", "avgoccs", ",", "finalmeas"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"\"\<savewfMMA\>\"", "/.", "saveparams"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"psi", "=", 
        RowBox[{"Import", "[", 
         RowBox[{"name", "<>", "\"\<_psi_MMAformat.m\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"DeleteFile", "[", 
        RowBox[{"name", "<>", "\"\<_psi_MMAformat.m\>\""}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Export", "[", 
        RowBox[{
         RowBox[{"name", "<>", "\"\<_psi_MMAformat.dat\>\""}], ",", 
         RowBox[{"Compress", "@", "psi"}], ",", "\"\<String\>\""}], "]"}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"Clear", "[", "psi", "]"}]}]}], "\[IndentingNewLine]", "]"}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Exit", "[", "]"}], ";"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.837071630061763*^9, {3.837071662662704*^9, 3.8370717608500853`*^9}, {
   3.8370718523127193`*^9, 3.8370719549983387`*^9}, {3.837071994973469*^9, 
   3.837072032861096*^9}, {3.837072126065878*^9, 3.8370721323258266`*^9}, {
   3.8370722858531437`*^9, 3.837072324882477*^9}, {3.837072367228277*^9, 
   3.837072418632189*^9}, {3.837072460144808*^9, 3.8370725620273848`*^9}, {
   3.837072592213888*^9, 3.837072622905242*^9}, {3.837072653103961*^9, 
   3.837072712850881*^9}, {3.837072754669842*^9, 3.837072768659812*^9}, {
   3.837072805048667*^9, 3.837072874033844*^9}, {3.837072939545093*^9, 
   3.8370729480856533`*^9}, {3.8370734466953297`*^9, 3.83707349155643*^9}, {
   3.837073627321102*^9, 3.8370736486423683`*^9}, {3.837073682000248*^9, 
   3.837073705294485*^9}, {3.837073795140849*^9, 3.8370738491674337`*^9}, {
   3.8370739301634274`*^9, 3.837073991783943*^9}, {3.83707403459661*^9, 
   3.8370740357128763`*^9}, {3.837074128497385*^9, 3.8370741966089907`*^9}, {
   3.837074237506465*^9, 3.837074237862617*^9}, {3.837074288295051*^9, 
   3.837074309326681*^9}, {3.8370743400284224`*^9, 3.8370743528126583`*^9}, {
   3.837074390401754*^9, 3.837074457091772*^9}, {3.8370745060237217`*^9, 
   3.83707452945682*^9}, {3.837074604762751*^9, 3.837074627163484*^9}, {
   3.837074697880392*^9, 3.83707473047841*^9}, 3.837074781942779*^9, {
   3.837074848674878*^9, 3.837074849387116*^9}, {3.837074884115348*^9, 
   3.837074998234866*^9}, {3.837075033527066*^9, 3.83707504364114*^9}, {
   3.837075193624255*^9, 3.837075229607823*^9}, 3.8370752711949453`*^9, {
   3.837075302366785*^9, 3.8370753187369137`*^9}, {3.837075351333789*^9, 
   3.837075357757113*^9}, {3.8370756364044313`*^9, 3.837075726397752*^9}, {
   3.83707580491967*^9, 3.837075833220605*^9}, {3.837075865774042*^9, 
   3.837075866181088*^9}, {3.8370759060007687`*^9, 3.837075906515725*^9}, {
   3.8370759434206667`*^9, 3.837075943824875*^9}, {3.8370763286277533`*^9, 
   3.837076378688772*^9}, {3.837076452471573*^9, 3.8370765761250143`*^9}, {
   3.837076620267144*^9, 3.837076620629057*^9}, {3.83707670168124*^9, 
   3.837076704492697*^9}, {3.8370767626965637`*^9, 3.837076817350432*^9}, {
   3.837077037086081*^9, 3.837077082601673*^9}, {3.83707716327134*^9, 
   3.837077186052307*^9}, {3.837077505593899*^9, 3.837077621641165*^9}, {
   3.8370777896673717`*^9, 3.837077795670434*^9}, {3.837077866273745*^9, 
   3.8370779182765102`*^9}, {3.837077982145246*^9, 3.837078058303219*^9}, {
   3.837078091146023*^9, 3.8370781209360323`*^9}, {3.8370782246785173`*^9, 
   3.837078261143779*^9}, {3.8370783924031*^9, 3.837078409031672*^9}, {
   3.837078442069395*^9, 3.83707846564604*^9}, {3.837078546259809*^9, 
   3.8370785861175213`*^9}, {3.837078643736238*^9, 3.837078643974135*^9}, 
   3.837078682544091*^9, {3.837078768217854*^9, 3.837078831452303*^9}, {
   3.8370788889347486`*^9, 3.8370788899477243`*^9}, {3.8370789216176033`*^9, 
   3.837078930670292*^9}, {3.837078968408086*^9, 3.837078969697554*^9}, {
   3.83707900010666*^9, 3.8370790540252733`*^9}, {3.837079110895318*^9, 
   3.837079200375174*^9}, {3.8370792852039757`*^9, 3.837079297433022*^9}, {
   3.8370793606738577`*^9, 3.837079360843317*^9}, {3.837079409859702*^9, 
   3.8370795132945347`*^9}, {3.837079589903874*^9, 3.837079592596117*^9}, {
   3.837079624703472*^9, 3.837079633414377*^9}, 3.83707967574957*^9, {
   3.837080276186502*^9, 3.8370802961209383`*^9}, {3.8370803301800537`*^9, 
   3.837080335744927*^9}, {3.837080504795467*^9, 3.837080510954585*^9}, 
   3.837080802146123*^9, {3.8371923571044683`*^9, 
   3.83719235744621*^9}},ExpressionUUID->"6ea2e2f7-aa31-4f15-a3bf-\
8ee7dc8a4716"]
},
WindowSize->{1234, 681},
WindowMargins->{{Automatic, -30}, {Automatic, 0}},
FrontEndVersion->"12.3 for Mac OS X x86 (64-bit) (May 11, 2021)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"cc391c7c-c028-462c-8f57-883c7253b795"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 73308, 1876, 5948, "Input",ExpressionUUID->"6ea2e2f7-aa31-4f15-a3bf-8ee7dc8a4716",
 InitializationCell->True]
}
]
*)

